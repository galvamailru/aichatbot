<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Чат</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 12px; background: #1a1a1a; color: #e0e0e0; min-height: 100vh; }
    .container { max-width: 640px; margin: 0 auto; display: flex; flex-direction: column; height: calc(100vh - 24px); }
    #messages { flex: 1; overflow-y: auto; padding: 8px; border: 1px solid #333; border-radius: 8px; margin-bottom: 8px; background: #252525; }
    .msg { margin: 6px 0; padding: 8px; border-radius: 6px; }
    .msg.user { background: #2a4a6a; }
    .msg.assistant { background: #2a3a2a; white-space: pre-wrap; word-break: break-word; }
    form { display: flex; gap: 8px; }
    #input { flex: 1; padding: 10px; border: 1px solid #444; border-radius: 6px; background: #252525; color: #e0e0e0; font-size: 1rem; }
    button { padding: 10px 16px; border: none; border-radius: 6px; background: #0d6efd; color: #fff; cursor: pointer; font-size: 1rem; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .error { color: #f66; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <div id="messages"></div>
    <form id="form">
      <input type="text" id="user_id" placeholder="User ID" value="user1" style="width: 90px;" />
      <input type="text" id="input" placeholder="Сообщение..." autocomplete="off" />
      <button type="submit" id="send">Отправить</button>
    </form>
    <div id="error" class="error"></div>
  </div>
  <script>
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const userId = document.getElementById('user_id');
    const messages = document.getElementById('messages');
    const errorEl = document.getElementById('error');
    const sendBtn = document.getElementById('send');

    function addMessage(role, content) {
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      div.textContent = content;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      const uid = userId.value.trim() || 'user1';
      errorEl.textContent = '';
      sendBtn.disabled = true;
      addMessage('user', text);
      const assistantBlock = addMessage('assistant', '');
      input.value = '';

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: uid, message: text, dialog_id: 'default' }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ detail: res.statusText }));
          throw new Error(err.detail || res.statusText);
        }
        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let buffer = '';
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += dec.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6).trim();
              if (data === '[DONE]') continue;
              assistantBlock.textContent += data;
              messages.scrollTop = messages.scrollHeight;
            }
          }
        }
      } catch (err) {
        errorEl.textContent = err.message || 'Ошибка запроса';
        assistantBlock.textContent = '(ошибка: ' + (err.message || 'неизвестно') + ')';
      } finally {
        sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
